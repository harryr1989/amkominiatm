<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AMKO ‚Äî Manajemen Pengguna</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{
    --bg:#F8FAFC;--panel:#FFFFFF;--text:#0F172A;--muted:#475569;
    --brand:#2563EB;--hover:#F1F5F9;--border:#E2E8F0;
    --shadow:0 6px 24px rgba(2,6,23,.06),0 2px 8px rgba(2,6,23,.05);
    --hdr-bg: rgba(37,99,235,.10); --hdr-border:#E2E8F0; --hdr-text:inherit;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:inherit;text-decoration:none}

  .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh;transition:grid-template-columns .25s ease}
  .sidebar{position:sticky;top:0;height:100vh;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;gap:12px;padding:14px;box-shadow:var(--shadow);z-index:10;overflow-y:auto}
  .brand{display:flex;align-items:center;gap:10px;padding:10px;border-radius:14px;background:linear-gradient(135deg,var(--panel),rgba(37,99,235,.08))}
  .brand .logo{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;background:var(--brand);color:#fff;font-weight:800}
  .brand .title{font-weight:700}

  .toolbar{display:flex;gap:8px}
  .btnx{padding:9px 12px;border:1px solid var(--border);background:var(--panel);border-radius:10px;cursor:pointer;color:var(--text)}
  .btnx:hover{background:var(--hover)}
  .mobile-toggle{display:none}

  .menu{display:flex;flex-direction:column;gap:4px}
  .item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;border:1px solid transparent;cursor:pointer}
  .item:hover{background:var(--hover);border-color:var(--border)}
  .item.active{background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.25)}
  .owner-only{display:none}
  body.owner .owner-only{display:flex}

  .topbar{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;padding:10px 14px;z-index:12}
  .content{padding:18px;display:grid;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px}

  /* Mobile nav toggle in topbar */
  .nav-toggle{display:none; align-items:center; justify-content:center; width:36px; height:36px; border:1px solid var(--border); border-radius:10px; background:#fff}
  .nav-toggle:active{transform:scale(.98)}

  @media (max-width:960px){
    .app{grid-template-columns:1fr}
    .sidebar{position:fixed;left:0;top:0;transform:translateX(-100%);transition:transform .2s;width:260px;z-index:20}
    .sidebar.open{transform:none}
    .mobile-toggle{display:inline-flex}
    .nav-toggle{display:inline-flex}
  }
  .collapse .label{display:none}
  .collapse .app{grid-template-columns:72px 1fr}
  .collapse .sidebar{padding:14px 10px}
  .collapse .search,.collapse .section{display:none}
  .collapse .item{justify-content:center}

  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{background:var(--hdr-bg)!important;color:var(--hdr-text)!important;border-top:1px solid var(--hdr-border)!important}
  th,td{padding:8px 10px;border-top:1px solid var(--border)}
  td.num{text-align:right}

  .chip{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #CBD5E1;background:#F1F5F9;color:#334155}

  /* ===== Reset Data block ===== */
  .reset-card{background:#fff;border:1px solid #E2E8F0;border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(2,6,23,.06)}
  .reset-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .reset-group{border:1px solid #E2E8F0;border-radius:12px;padding:12px}
  .reset-group h4{margin:0 0 8px;font-size:14px}
  .reset-note{font-size:12px;color:#64748B}
  .reset-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

  /* ===== Mobile-friendly enhancements ===== */
  :root{
    --font-base: 14px; --line-base: 1.55; --fz-chip: 12px; --fz-label: 12.5px; --fz-input: 13px; --fz-btn: 13px;
    --ctrl-h: 40px; --pad-input-x: 12px; --pad-btn-y: .5rem; --pad-btn-x: .7rem; --tbl-pad-y: 9px; --tbl-pad-x: 10px;
  }
  label, .form-label{ font-size: var(--fz-label); margin-bottom: 2px; }
  input.form-control, .form-control, select.form-select, .form-select{
    height: var(--ctrl-h); padding: 0 var(--pad-input-x); font-size: var(--fz-input); line-height: 1.3;
  }
  .btn, .btnx{ font-size: var(--fz-btn); height: var(--ctrl-h); padding: var(--pad-btn-y) var(--pad-btn-x); border-radius: 10px; }
  .content{ padding:14px; gap:12px } .card{ border-radius:14px; padding:14px }

  .filters, .filter-grid, .hdr-actions{ display:flex; flex-wrap:wrap; gap:8px } .filter-grid > *{ min-width:160px }

  /* Cards on phones */
  @media (max-width: 720px){
    .table-responsive{ overflow:visible }
    table thead{ display:none }
    #tblUsers tr, #tblBranches tr{ display:block; border:1px solid var(--border); border-radius:12px; padding:8px; margin:8px 0; background:#fff }
    #tblUsers td, #tblBranches td{ display:flex; justify-content:space-between; gap:12px; border-top:none; padding:8px 6px }
    #tblBranches tr td:nth-child(1)::before{ content:'#'; font-weight:600; color:#64748B }
    #tblBranches tr td:nth-child(2)::before{ content:'Nama Cabang'; font-weight:600; color:#64748B }
    #tblBranches tr td:nth-child(3)::before{ content:'Aksi'; font-weight:600; color:#64748B }
    #tblUsers tr td:nth-child(1)::before{ content:'Username'; font-weight:600; color:#64748B }
    #tblUsers tr td:nth-child(2)::before{ content:'Nama'; font-weight:600; color:#64748B }
    #tblUsers tr td:nth-child(3)::before{ content:'Role'; font-weight:600; color:#64748B }
    #tblUsers tr td:nth-child(4)::before{ content:'Cabang'; font-weight:600; color:#64748B }
    #tblUsers tr td:nth-child(5)::before{ content:'Aksi'; font-weight:600; color:#64748B }
    #tblUsers .d-flex{ flex-wrap:wrap; gap:6px }
    #tblUsers .d-flex .btn{ flex:1 1 calc(50% - 6px) }
  }

  .fab{ position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:999px; display:none;
        align-items:center; justify-content:center; box-shadow:var(--shadow); z-index:40 }
  @media (max-width:960px){ .fab{ display:inline-flex } }

  @media (max-width:576px){
    .modal-dialog{ margin:0; max-width:none }
    .modal-content{ min-height:100vh; border-radius:0 }
    .modal-header{ position:sticky; top:0; z-index:1; background:#fff }
  }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" aria-label="Sidebar">
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <div class="title">AMKO Panel</div>
        <div style="font-size:12px;color:var(--muted)">Mini ATM</div>
      </div>
    </div>

    <div class="toolbar">
      <button id="collapseBtn" class="btnx" title="Kecilkan / Besarkan Sidebar">‚ü∑</button>
      <button id="mobileOpen" class="btnx mobile-toggle" title="Tutup">‚úï</button>
    </div>

    <div class="section" style="font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);padding:6px 10px;margin-top:6px">Menu</div>
    <nav class="menu">
      <a class="item" href="dashboard.html"><span class="label">üìä Dashboard</span></a>
      <a class="item" href="saldo-real.html"><span class="label">üìë Saldo Real</span></a>
      <a class="item" href="master-saldo-akun.html"><span class="label">üí∞ Master Akun Saldo</span></a>
      <a class="item" href="mutasi-saldo.html"><span class="label">üîÑ Mutasi Saldo</span></a>
      <a class="item" href="transaksi-mini-atm.html"><span class="label">üèß Transaksi Mini ATM</span></a>
      <a class="item active owner-only" href="manajemen-pengguna.html"><span class="label">üë• Manajemen Pengguna</span></a>
      <a class="item" href="#" id="logoutLink"><span class="label">üö™ Logout</span></a>
    </nav>

    <div class="section" style="font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);padding:6px 10px;margin-top:6px">Info</div>
    <div style="font-size:12px;color:var(--muted);padding:8px 10px;border:1px dashed var(--border);border-radius:10px">
      Login: <strong id="currentUser">‚Äî</strong>
    </div>
  </aside>

  <main>
    <header class="topbar">
      <button class="nav-toggle" id="navToggle" aria-label="Menu">‚ò∞</button>
      <strong>Manajemen Pengguna</strong>
      <span class="chip" id="userCountChip">‚Äî pengguna</span>
    </header>

    <section class="content">
      <div class="card">
        <div class="d-flex flex-wrap align-items-end gap-2">
          <div>
            <label class="form-label">Cari</label>
            <input id="fSearch" type="text" class="form-control" placeholder="Nama/username"/>
          </div>
          <div>
            <label class="form-label">Role</label>
            <select id="fRole" class="form-select">
              <option value="__ALL__">Semua</option>
              <option value="owner">Owner</option>
              <option value="admin">Admin</option>
              <option value="kasir">Kasir</option>
            </select>
          </div>
          <div>
            <label class="form-label">Cabang</label>
            <select id="fBranch" class="form-select">
              <option value="__ALL__">Semua</option>
            </select>
          </div>
          <div class="ms-auto d-flex gap-2">
            <button id="btnAdd" class="btn btn-primary">+ Tambah Pengguna</button>
            <button id="btnExport" class="btn btn-outline-secondary">‚¨áÔ∏è Export CSV</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="d-flex align-items-end gap-2 flex-wrap">
          <div style="flex:1 1 220px; min-width:220px">
            <label class="form-label">Nama Cabang Baru</label>
            <input id="inpBranch" type="text" class="form-control" placeholder="cth: AMKO 18"/>
          </div>
          <button id="btnAddBranch" class="btn btn-success">+ Tambah Cabang</button>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr><th style="width:60px">#</th><th>Nama Cabang</th><th style="width:140px">Aksi</th></tr></thead>
            <tbody id="tblBranches"><tr><td colspan="3" class="text-muted">Belum ada cabang.</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Username</th>
                <th>Nama</th>
                <th>Role</th>
                <th>Cabang</th>
                <th style="width:220px">Aksi</th>
              </tr>
            </thead>
            <tbody id="tblUsers">
              <tr><td colspan="5" class="text-muted">Belum ada data.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="resetDataWrap" class="reset-card" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <strong>Reset Data</strong>
            <div class="reset-note">Centang data yang ingin dihapus / di-nol-kan. Fitur ini hanya untuk <b>Owner</b>.</div>
          </div>
          <div>
            <label class="reset-note">Cabang</label>
            <select id="resetBranch" class="form-select" style="min-width:220px">
              <option value="__ALL__">Semua Cabang</option>
            </select>
          </div>
        </div>

        <div class="reset-grid" style="margin-top:12px">
          <div class="reset-group">
            <h4>Global (tidak tergantung cabang)</h4>
            <label><input type="checkbox" id="chkUsers"/> Users & Roles</label><br/>
            <label><input type="checkbox" id="chkAuth"/> Auth Session</label><br/>
            <label><input type="checkbox" id="chkBranches"/> Daftar Cabang</label>
            <div class="reset-note" style="margin-top:6px">Kunci: <code>amko.users</code>, <code>amko.auth</code>, <code>amko.auth:exp</code>, <code>amko.branches</code></div>
          </div>

          <div class="reset-group">
            <h4>Master Akun Saldo</h4>
            <label><input type="checkbox" id="chkSaldoZero"/> Nol-kan saldo & saldo_awal (simpan daftar akun)</label><br/>
            <label><input type="checkbox" id="chkAkunDelete"/> Hapus semua akun (hapus <code>akun@{cabang}</code>)</label>
            <div class="reset-note" style="margin-top:6px">Kunci: <code>akun@{cabang}</code></div>
          </div>

          <div class="reset-group">
            <h4>Mutasi & Transaksi</h4>
            <label><input type="checkbox" id="chkMutasi"/> Hapus Mutasi Saldo</label><br/>
            <label><input type="checkbox" id="chkTransaksi"/> Hapus Transaksi Mini ATM</label>
            <div class="reset-note" style="margin-top:6px">Kunci: <code>mutasi@{cabang}</code>, <code>mutasi</code>, <code>transaksi@{cabang}</code>, <code>trx@{cabang}</code>, <code>transaksi</code>, <code>trx</code></div>
          </div>

          <div class="reset-group">
            <h4>Riwayat Mutasi</h4>
            <label><input type="checkbox" id="chkMutasiHist"/> Hapus Riwayat Mutasi</label>
            <div class="reset-note" style="margin-top:6px">
              Kunci utama: <code>riwayatSaldo@{cabang}</code> ¬∑ juga dibersihkan jika ada: <code>riwayatSaldo</code>, <code>riwayat_mutasi@{cabang}</code>, <code>mutasi_log@{cabang}</code>
            </div>
          </div>

          <div class="reset-group">
            <h4>Riwayat Saldo Awal</h4>
            <label><input type="checkbox" id="chkHist"/> Hapus Riwayat Saldo Awal</label>
            <div class="reset-note" style="margin-top:6px">Kunci: <code>histori_saldo_awal@{cabang}</code></div>
          </div>

          <div class="reset-group">
            <h4>Riwayat Transaksi Mini ATM</h4>
            <label><input type="checkbox" id="chkTransaksiHist"/> Hapus Riwayat Transaksi Mini ATM</label>
            <div class="reset-note" style="margin-top:6px">
              Kunci (variasi): <code>riwayatTransaksi@{cabang}</code>, <code>riwayat_transaksi@{cabang}</code>, <code>transaksi_log@{cabang}</code>, <code>trx_log@{cabang}</code> ¬∑ global: <code>riwayatTransaksi</code>, <code>transaksi_log</code>, <code>trx_log</code>
            </div>
          </div>

          <div class="reset-group" style="border-color:#ef4444">
            <h4 style="color:#ef4444">Factory Reset (Kosongkan Semua Data)</h4>
            <label>
              <input type="checkbox" id="chkFactoryReset"/>
              Hapus <b>SEMUA</b> data & kembalikan ke setelan awal (menyisakan 1 akun owner & akun LACI TUNAI per cabang).
            </label>
            <div class="reset-note" style="margin-top:6px">
              Konfirmasi khusus: ketik <code>FACTORY</code> di kolom konfirmasi.
            </div>
          </div>
        </div>

        <div class="reset-actions">
          <label class="reset-note"><input type="checkbox" id="chkUnderstand"/> Saya paham tindakan ini tidak bisa dibatalkan.</label>
          <input type="text" id="confirmText" class="form-control" placeholder='Ketik "RESET" atau "FACTORY"' style="max-width:220px"/>
          <button id="btnPreview" class="btn btn-outline-secondary">Lihat Kunci yang Akan Dihapus</button>
          <button id="btnDoReset" class="btn btn-danger" disabled>Reset Data Terpilih</button>
        </div>

        <div id="previewKeys" class="reset-note" style="margin-top:10px;white-space:pre-wrap;display:none"></div>
      </div>

    </section>
  </main>
</div>

<button id="fabAdd" class="fab btn btn-primary" title="Tambah Pengguna">Ôºã</button>

<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <form id="userForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userModalTitle">Tambah Pengguna</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="fEditing" value=""/>
        <div class="mb-2">
          <label class="form-label">Username</label>
          <input id="fUsername" class="form-control" autocomplete="off" required/>
        </div>
        <div class="mb-2">
          <label class="form-label">Nama</label>
          <input id="fName" class="form-control" autocomplete="off" required/>
        </div>
        <div class="mb-2">
          <label class="form-label">Role</label>
          <select id="fRoleEdit" class="form-select" required>
            <option value="owner">Owner</option>
            <option value="admin">Admin</option>
            <option value="kasir">Kasir</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Cabang</label>
          <select id="fBranchEdit" class="form-select">
            <option value="">(Tanpa cabang)</option>
          </select>
          <div class="form-text">Owner boleh tanpa cabang. Admin/Kasir sebaiknya pilih cabang.</div>
        </div>
        <div class="mb-2">
          <label class="form-label">Password</label>
          <input id="fPassword" type="password" class="form-control" placeholder="(Biarkan kosong saat edit untuk tidak mengubah)"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Batal</button>
        <button class="btn btn-primary" type="submit">Simpan</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const AUTH_KEY='amko.auth', EXP_KEY=AUTH_KEY+':exp';
  const USERS_KEY='amko.users', BR_KEY='amko.branches', ACC_BASE='akun';
  const $=(s,el=document)=>el.querySelector(s);
  const $$=(s,el=document)=>[...el.querySelectorAll(s)];

  function getSession(){ try{return JSON.parse(localStorage.getItem(AUTH_KEY)||'null')}catch{return null} }
  function isOwner(){ return ((getSession()?.role||'').toLowerCase()==='owner'); }
  function getUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)||'[]') }catch{ return [] } }
  function setUsers(arr){ localStorage.setItem(USERS_KEY, JSON.stringify(arr||[])); }
  function getBranches(){ try{ const bs=JSON.parse(localStorage.getItem(BR_KEY)||'[]'); return Array.isArray(bs)? bs : [] }catch{ return [] } }
  function setBranches(arr){ localStorage.setItem(BR_KEY, JSON.stringify(arr||[])); }
  function ensureSeed(){ let users=getUsers(); if(!users.length){ users=[ {username:'owner1',password:'123',name:'Owner Utama',role:'owner',branch:''} ]; setUsers(users); } return users; }

  const state = { users: [], filters: { q:'', role:'__ALL__', branch:'__ALL__' }, modal: null, branches: [] };

  function applyFilters(users){
    const {q,role,branch}=state.filters;
    const ql=(q||'').trim().toLowerCase();
    return users.filter(u=>{
      const okQ = !ql || (u.username?.toLowerCase().includes(ql) || (u.name||'').toLowerCase().includes(ql));
      const okR = (role==='__ALL__') || ((u.role||'').toLowerCase()===role);
      const okB = (branch==='__ALL__') || ((u.branch||'')===branch);
      return okQ && okR && okB;
    });
  }

  function syncBranchDropdowns(){
    const f=$('#fBranch'); f.innerHTML='<option value="__ALL__">Semua</option>' + state.branches.map(b=>`<option value="${b}">${b}</option>`).join('');
    const fe=$('#fBranchEdit'); fe.innerHTML='<option value="">(Tanpa cabang)</option>' + state.branches.map(b=>`<option value="${b}">${b}</option>`).join('');
    const r=$('#resetBranch'); r.innerHTML='<option value="__ALL__">Semua Cabang</option>' + state.branches.map(b=>`<option value="${b}">${b}</option>`).join('');
  }

  function renderBranches(){
    const tb=$('#tblBranches');
    if(!state.branches.length){ tb.innerHTML = `<tr><td colspan="3" class="text-muted">Belum ada cabang.</td></tr>`; return; }
    tb.innerHTML = state.branches.map((b,i)=>`
      <tr>
        <td data-label="#">${i+1}</td>
        <td data-label="Nama Cabang"><span class="chip">${b}</span></td>
        <td data-label="Aksi">
          <button class="btn btn-sm btn-outline-danger" data-del="${b}">Hapus</button>
        </td>
      </tr>
    `).join('');
    $$('#tblBranches [data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const name=btn.getAttribute('data-del');
        if(!confirm('Hapus cabang "'+name+'"?\nData terkait (akun, mutasi, transaksi) tidak ikut dihapus dari halaman ini.')) return;
        state.branches = state.branches.filter(x=>x!==name);
        setBranches(state.branches);
        syncBranchDropdowns();
        renderBranches();
      });
    });
  }

  function renderUsers(){
    const users = applyFilters(state.users);
    $('#userCountChip').textContent = `${state.users.length} pengguna`;
    const tb=$('#tblUsers');
    if(!users.length){ tb.innerHTML = `<tr><td colspan="5" class="text-muted">Tidak ada data.</td></tr>`; return; }
    tb.innerHTML = users.map(u=>`
      <tr>
        <td data-label="Username"><code>${u.username}</code></td>
        <td data-label="Nama">${u.name||'-'}</td>
        <td data-label="Role"><span class="chip">${(u.role||'-').toUpperCase()}</span></td>
        <td data-label="Cabang">${u.branch? `<span class="chip">${u.branch}</span>`:'‚Äî'}</td>
        <td data-label="Aksi">
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${u.username}">Edit</button>
            <button class="btn btn-sm btn-outline-secondary" data-act="resetpw" data-id="${u.username}">Reset PW</button>
            <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${u.username}">Hapus</button>
          </div>
        </td>
      </tr>
    `).join('');

    $$('#tblUsers [data-act]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const act=btn.getAttribute('data-act');
        const id=btn.getAttribute('data-id');
        if(act==='edit') openEdit(id);
        if(act==='resetpw') resetPw(id);
        if(act==='del') delUser(id);
      });
    });
  }

  function openAdd(){ $('#userForm').reset(); $('#fEditing').value=''; $('#userModalTitle').textContent='Tambah Pengguna'; $('#fUsername').disabled=false; $('#fPassword').placeholder='Set password awal'; state.modal.show(); }
  function openEdit(username){
    const u=state.users.find(x=>x.username===username); if(!u) return;
    $('#userForm').reset();
    $('#fEditing').value=username;
    $('#userModalTitle').textContent='Edit Pengguna';
    $('#fUsername').value=u.username; $('#fUsername').disabled=true;
    $('#fName').value=u.name||'';
    $('#fRoleEdit').value=(u.role||'owner');
    $('#fBranchEdit').value=u.branch||'';
    $('#fPassword').value=''; $('#fPassword').placeholder='(Kosongkan jika tidak mengubah)';
    state.modal.show();
  }
  function resetPw(username){
    const users=[...state.users];
    const i=users.findIndex(x=>x.username===username);
    if(i<0) return;
    const pw=prompt('Masukkan password baru untuk '+username+':','123');
    if(pw===null) return;
    users[i].password=String(pw);
    setUsers(users); state.users=users; alert('Password telah diubah.');
  }
  function delUser(username){
    if(!confirm('Hapus pengguna '+username+' ?')) return;
    const users=state.users.filter(x=>x.username!==username);
    setUsers(users); state.users=users; renderUsers();
  }
  function saveForm(e){
    e.preventDefault();
    const editing=$('#fEditing').value;
    const username=$('#fUsername').value.trim();
    const name=$('#fName').value.trim();
    const role=$('#fRoleEdit').value;
    const branch=$('#fBranchEdit').value;
    const pw=$('#fPassword').value;
    if(!username || !name){ alert('Username & Nama wajib.'); return; }
    const users=[...state.users];
    if(editing){
      const i=users.findIndex(x=>x.username===editing);
      if(i<0){ alert('User tidak ditemukan.'); return; }
      users[i].name=name; users[i].role=role; users[i].branch=branch;
      if(pw) users[i].password=pw;
    }else{
      if(users.some(x=>x.username===username)){ alert('Username sudah ada.'); return; }
      users.push({username,password: pw||'123', name, role, branch});
    }
    setUsers(users); state.users=users; renderUsers(); state.modal.hide();
  }
  function exportCSV(){
    const users=applyFilters(state.users);
    const lines=[['username','name','role','branch'].join(',')];
    users.forEach(u=> lines.push([u.username, u.name||'', u.role||'', u.branch||''].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')));
    const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='users.csv'; a.click(); URL.revokeObjectURL(url);
  }

  function forEachBranch(branchSel, fn){
    const branches = (branchSel==='__ALL__') ? state.branches : [branchSel];
    branches.forEach(b=> fn(b));
  }
  function buildPreview(){
    const branchSel = $('#resetBranch').value || '__ALL__';
    const keys = [];
    if($('#chkUsers').checked) keys.push('amko.users');
    if($('#chkAuth').checked){ keys.push('amko.auth','amko.auth:exp'); }
    if($('#chkBranches').checked) keys.push('amko.branches');
    if($('#chkSaldoZero').checked || $('#chkAkunDelete').checked){ forEachBranch(branchSel, b=> keys.push(`akun@${b}`)); }
    if($('#chkMutasi').checked){ if(branchSel==='__ALL__'){ keys.push('mutasi'); } forEachBranch(branchSel, b=> keys.push(`mutasi@${b}`)); }
    if($('#chkTransaksi').checked){ if(branchSel==='__ALL__'){ keys.push('transaksi','trx'); } forEachBranch(branchSel, b=> keys.push(`transaksi@${b}`, `trx@${b}`)); }
    if($('#chkMutasiHist').checked){ if(branchSel==='__ALL__'){ keys.push('riwayatSaldo'); } forEachBranch(branchSel, b=>{ keys.push(`riwayatSaldo@${b}`); keys.push(`riwayat_mutasi@${b}`); keys.push(`mutasi_log@${b}`); }); }
    if($('#chkTransaksiHist').checked){ if(branchSel==='__ALL__'){ keys.push('riwayatTransaksi','transaksi_log','trx_log'); } forEachBranch(branchSel, b=>{ keys.push(`riwayatTransaksi@${b}`); keys.push(`riwayat_transaksi@${b}`); keys.push(`transaksi_log@${b}`); keys.push(`trx_log@${b}`); }); }
    if($('#chkHist').checked){ forEachBranch(branchSel, b=> keys.push(`histori_saldo_awal@${b}`)); }
    if($('#chkFactoryReset').checked){ keys.push('[SELURUH KUNCI APLIKASI, CABANG DIPERTAHANKAN, AKUN LACI TUNAI DISISAKAN PER CABANG]'); }
    return keys;
  }
  function previewKeys(){
    const out = buildPreview();
    const el = $('#previewKeys');
    el.style.display = 'block';
    el.textContent = out.length ? ('Kunci yang akan dihapus/diubah:\n- ' + out.join('\n- ')) : 'Tidak ada yang dipilih.';
  }
  function doReset(){
    if ($('#chkFactoryReset')?.checked) {
      try{
        const branchesBefore = getBranches();
        const toRemove=[];
        for(let i=0;i<localStorage.length;i++){
          const k=localStorage.key(i); if(!k) continue;
          if (k === 'amko.branches') continue;
          if (k.startsWith('amko.') || k.startsWith('akun@') || k.startsWith('mutasi') || k.startsWith('transaksi') || k.startsWith('trx') || k.startsWith('riwayat') || k.startsWith('histori_saldo_awal@') || k.startsWith('ms:') || k.startsWith('tx:') || k.startsWith('saldoAwal.')){
            toRemove.push(k);
          }
        }
        toRemove.forEach(k=> localStorage.removeItem(k));
        setUsers([{ username:'owner1', password:'123', name:'Owner', role:'owner', branch:'' }]);
        ['transaksi','trx','riwayatTransaksi','transaksi_log','trx_log','riwayatSaldo'].forEach(k=> localStorage.removeItem(k));
        branchesBefore.forEach(b=>{
          ['transaksi@'+b,'trx@'+b,'riwayatTransaksi@'+b,'riwayat_transaksi@'+b,'transaksi_log@'+b,'trx_log@'+b,'riwayatSaldo@'+b,'riwayat_mutasi@'+b,'mutasi_log@'+b,'mutasi@'+b].forEach(k=> localStorage.removeItem(k));
        });
        const ACC_BASE='akun'; const today = new Date().toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});
        branchesBefore.forEach(b=>{ const key = `${ACC_BASE}@${b}`; const laci = [{ nama:'LACI TUNAI', jenis:'cash', saldo:0, saldoAwal:0, ket:'', update: today, locked:true }]; localStorage.setItem(key, JSON.stringify(laci)); });
        localStorage.removeItem('amko.auth'); localStorage.removeItem('amko.auth:exp');
        alert('Factory Reset selesai.\nSilakan login dengan: owner1 / 123');
        location.href='login.html'; return;
      }catch(e){ alert('Terjadi kesalahan saat Factory Reset: '+e.message); return; }
    }
    const branchSel = $('#resetBranch').value || '__ALL__';
    if($('#chkUsers').checked){ localStorage.removeItem('amko.users'); }
    if($('#chkAuth').checked){ localStorage.removeItem('amko.auth'); localStorage.removeItem('amko.auth:exp'); }
    if($('#chkBranches').checked){ localStorage.removeItem('amko.branches'); state.branches=[]; syncBranchDropdowns(); renderBranches(); }
    if($('#chkSaldoZero').checked){ const ACC_BASE='akun'; const setZero=(b)=>{ try{ const key=`${ACC_BASE}@${b}`; const arr=JSON.parse(localStorage.getItem(key)||'[]'); if(Array.isArray(arr)){ arr.forEach(a=>{ a.saldo=0; a.saldo_awal=0; a.updated_at=new Date().toISOString(); }); localStorage.setItem(key, JSON.stringify(arr)); } }catch{} }; const branches=(branchSel==='__ALL__')? state.branches:[branchSel]; branches.forEach(setZero); }
    if($('#chkAkunDelete').checked){ const ACC_BASE='akun'; const del=(b)=> localStorage.removeItem(`${ACC_BASE}@${b}`); const branches=(branchSel==='__ALL__')? state.branches:[branchSel]; branches.forEach(del); }
    if($('#chkMutasi').checked){ if(branchSel==='__ALL__'){ localStorage.removeItem('mutasi'); } const branches=(branchSel==='__ALL__')? state.branches:[branchSel]; branches.forEach(b=> localStorage.removeItem(`mutasi@${b}`)); }
    if($('#chkTransaksi').checked){ if(branchSel==='__ALL__'){ localStorage.removeItem('transaksi'); localStorage.removeItem('trx'); } const branches=(branchSel==='__ALL__')? state.branches:[branchSel]; branches.forEach(b=>{ localStorage.removeItem(`transaksi@${b}`); localStorage.removeItem(`trx@${b}`); }); }
    if($('#chkMutasiHist').checked){ if(branchSel==='__ALL__'){ localStorage.removeItem('riwayatSaldo'); } const branches=(branchSel==='__ALL__')? state.branches:[branchSel]; branches.forEach(b=>{ localStorage.removeItem(`riwayatSaldo@${b}`); localStorage.removeItem(`riwayat_mutasi@${b}`); localStorage.removeItem(`mutasi_log@${b}`); }); ['ms:filter','ms:last:tambah','ms:last:kurang','ms:last:sumber','ms:last:tujuan'].forEach(k=> localStorage.removeItem(k)); }
    if($('#chkTransaksiHist').checked){ if(branchSel==='__ALL__'){ localStorage.removeItem('riwayatTransaksi'); localStorage.removeItem('transaksi_log'); localStorage.removeItem('trx_log'); } const branches=(branchSel==='__ALL__')? state.branches:[branchSel]; const cleanSoft=(key)=>{ try{ const arr = JSON.parse(localStorage.getItem(key)||'[]'); if(!Array.isArray(arr)||!arr.length) return; const cleaned = arr.filter(t=>{ const ket=(t.ket||t.keterangan||'').toString().toUpperCase(); const soft=(t.deleted===true)||ket.includes('[HAPUS:'); return !soft; }); localStorage.setItem(key, JSON.stringify(cleaned)); }catch{} }; branches.forEach(b=>{ localStorage.removeItem(`riwayatTransaksi@${b}`); localStorage.removeItem(`riwayat_transaksi@${b}`); localStorage.removeItem(`transaksi_log@${b}`); localStorage.removeItem(`trx_log@${b}`); cleanSoft(`transaksi@${b}`); cleanSoft(`trx@${b}`); }); if(branchSel==='__ALL__'){ cleanSoft('transaksi'); cleanSoft('trx'); } ['tx:filter','tx:last:jenis','tx:last:cabang'].forEach(k=> localStorage.removeItem(k)); }
    if($('#chkHist').checked){ const branches=(branchSel==='__ALL__')? state.branches:[branchSel]; branches.forEach(b=> localStorage.removeItem(`histori_saldo_awal@${b}`)); }
    alert('Selesai. Data terpilih telah direset.');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const s=getSession(); if(!s){ location.replace('login.html'); return; } if((s.role||'').toLowerCase()!=='owner'){ location.replace('transaksi-mini-atm.html'); return; }
    document.body.classList.add('owner'); $('#currentUser').textContent = s.username || s.name || 'Owner';
    $('#collapseBtn')?.addEventListener('click', ()=> document.body.classList.toggle('collapse'));
    $('#logoutLink')?.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.removeItem('amko.auth'); localStorage.removeItem('amko.auth:exp'); location.href='login.html'; });
    $('#navToggle')?.addEventListener('click', ()=> document.querySelector('.sidebar')?.classList.toggle('open'));
    state.users = ensureSeed();
    state.branches = getBranches(); syncBranchDropdowns(); renderBranches();
    $('#fSearch').addEventListener('input', e=>{ state.filters.q=e.target.value; renderUsers(); });
    $('#fRole').addEventListener('change', e=>{ state.filters.role=e.target.value; renderUsers(); });
    $('#fBranch').addEventListener('change', e=>{ state.filters.branch=e.target.value; renderUsers(); });
    state.modal = new bootstrap.Modal($('#userModal'));
    $('#btnAdd').addEventListener('click', openAdd);
    $('#fabAdd').addEventListener('click', ()=> $('#btnAdd').click());
    $('#userForm').addEventListener('submit', saveForm);
    $('#btnExport').addEventListener('click', exportCSV);
    $('#btnAddBranch').addEventListener('click', ()=>{
      const name=($('#inpBranch').value||'').trim();
      if(!name){ alert('Nama cabang tidak boleh kosong.'); return; }
      if(state.branches.includes(name)){ alert('Cabang sudah ada.'); return; }
      state.branches.push(name);
      setBranches(state.branches);
      $('#inpBranch').value='';
      syncBranchDropdowns(); renderBranches();
      alert('Cabang ditambahkan.');
    });
    const wrap = $('#resetDataWrap'); wrap.style.display='block';
    function updateButtonState(){
      const anyChecked = [
        '#chkUsers','#chkAuth','#chkBranches','#chkSaldoZero','#chkAkunDelete',
        '#chkMutasi','#chkTransaksi','#chkMutasiHist','#chkTransaksiHist','#chkHist','#chkFactoryReset'
      ].some(id=> $(id)?.checked );
      const text = $('#confirmText').value.trim().toUpperCase();
      const needWord = $('#chkFactoryReset').checked ? 'FACTORY' : 'RESET';
      const okUnderstand = $('#chkUnderstand').checked && (text===needWord);
      $('#btnDoReset').disabled = !(anyChecked && okUnderstand);
    }
    $$('#resetDataWrap input').forEach(inp=> inp.addEventListener('input', updateButtonState));
    $('#btnPreview').addEventListener('click', previewKeys);
    $('#btnDoReset').addEventListener('click', ()=>{
      const preview = buildPreview();
      if(!preview.length){ alert('Tidak ada pilihan.'); return; }
      if(!confirm('Yakin reset data terpilih?\n\n'+preview.join('\n'))){ return; }
      doReset();
    });
    updateButtonState();
    renderUsers();
  });
})();
</script>

<script>
document.querySelectorAll('#mobileOpen').forEach(btn=>{
  btn.addEventListener('click',()=>document.querySelector('.sidebar')?.classList.add('open'));
});
document.querySelectorAll('#mobileClose').forEach(btn=>{
  btn.addEventListener('click',()=>document.querySelector('.sidebar')?.classList.remove('open'));
});
</script>

</body>
</html>
